version: 2.1
executors:
  go:
    docker:
      - image: cimg/go:1.15.5
    environment:
      VERSION: 2.0.0
orbs:
  go: circleci/go@1.5.0
  aws-ecr: circleci/aws-ecr@6.2.0
jobs:
  test:
    executor: go
    steps:
      - checkout
      - go/mod-download-cached
      - run: go build ./...
  lint:
    executor: go
    steps:
      - run: go get honnef.co/go/tools/cmd/staticcheck
      - checkout
      - run: go vet ./...
  tag:
    executor: go
    docker:
      - image: cimg/base:2020.05
    steps:
      - add_ssh_keys:
          fingerprints:
            - "ec:9f:28:a5:62:74:20:4f:61:76:ff:2a:0e:d0:b7:f8"
      - checkout
      - run: |
          TAG="v$VERSION-$CIRCLE_BUILD_NUM-prod"
          git tag $TAG
          git push origin $TAG
  tag-development:
    executor: go
    docker:
      - image: cimg/base:2020.05
    steps:
      - add_ssh_keys:
          fingerprints:
            - "ec:9f:28:a5:62:74:20:4f:61:76:ff:2a:0e:d0:b7:f8"
      - checkout
      - run: |
          TAG="v$VERSION-$CIRCLE_BUILD_NUM-dev"
          git tag $TAG
          git push origin $TAG
  publish:
    executor: go
    docker:
      - image: cimg/base:2020.05
    steps:
      - setup_remote_docker:
          version: 19.03.12
      - checkout
      - aws-ecr/build-and-push-image:
          account-url: AWS_ECR_ACCOUNT_URL
          aws-access-key-id: AWS_ACCESS_KEY_ID_PRODUCTION
          aws-secret-access-key: AWS_SECRET_ACCESS_KEY_PRODUCTION
          create-repo: true
          dockerfile: Dockerfile
          region: AWS_REGION_SA_EAST_1
          repo: 'ze-delivery'
          tag: "$CIRCLE_SHA1"
  publish-development:
    executor: go
    docker:
      - image: cimg/base:2020.05
    steps:
      - setup_remote_docker:
          version: 19.03.12
      - checkout
      - aws-ecr/build-and-push-image:
          account-url: AWS_ECR_ACCOUNT_URL
          aws-access-key-id: AWS_ACCESS_KEY_ID_DEVELOPMENT
          aws-secret-access-key: AWS_SECRET_ACCESS_KEY_DEVELOPMENT
          create-repo: true
          dockerfile: Dockerfile
          region: AWS_REGION_SA_EAST_1
          repo: 'ze-delivery'
          tag: "$CIRCLE_SHA1"
workflows:
  version: 2
  pipeline:
    jobs:
      - test:
          filters:
            tags:
              only: /v.*/
      - lint:
          filters:
            tags:
              only: /v.*/
      - tag:
          requires:
            - test
            - lint
          filters:
            branches:
              only: 
                - main
      - tag-development:
          requires:
            - test
            - lint
          filters:
            branches:
              only: 
                - development
      - publish:
          context: ze_delivery
          requires:
            - test
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v[0-9]+(\.[0-9]+)+(\-[0-9]+)+(\-prod)/
      - publish-development:
          context: ze_delivery
          requires:
            - test
            - lint
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v[0-9]+(\.[0-9]+)+(\-[0-9]+)+(\-dev)/
